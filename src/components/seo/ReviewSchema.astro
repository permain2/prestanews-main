---
/**
 * Review Schema - JSON-LD structured data for product reviews
 * Shows star ratings in Google search results
 * Use on: Credit card reviews, insurance reviews, product comparisons
 */
import { SITE_TITLE, SITE_URL } from '../../consts';

interface Props {
  itemName: string;
  itemType?: 'Product' | 'FinancialProduct' | 'CreditCard' | 'InsurancePolicy' | 'Service';
  description: string;
  rating: number; // 1-5 scale
  reviewCount?: number; // If not provided, generates random between 47-234
  author?: string;
  datePublished: Date;
  image?: string;
  url: string;
  pros?: string[];
  cons?: string[];
}

const {
  itemName,
  itemType = 'FinancialProduct',
  description,
  rating,
  reviewCount,
  author = 'Screened Editorial Team',
  datePublished,
  image,
  url,
  pros = [],
  cons = [],
} = Astro.props;

// Generate random review count between 47-234 if not provided
const actualReviewCount = reviewCount ?? Math.floor(Math.random() * (234 - 47 + 1)) + 47;

// Ensure rating is between 1-5
const normalizedRating = Math.min(5, Math.max(1, rating));

const fullUrl = url.startsWith('http') ? url : `${SITE_URL}${url}`;
const imageUrl = image ? (image.startsWith('http') ? image : `${SITE_URL}${image}`) : null;

// Build review body from pros/cons if available
let reviewBody = description;
if (pros.length > 0 || cons.length > 0) {
  reviewBody = description;
  if (pros.length > 0) {
    reviewBody += ` Pros: ${pros.join(', ')}.`;
  }
  if (cons.length > 0) {
    reviewBody += ` Cons: ${cons.join(', ')}.`;
  }
}

const schema = {
  "@context": "https://schema.org",
  "@type": "Review",
  "itemReviewed": {
    "@type": itemType,
    "name": itemName,
    "description": description,
    ...(imageUrl && { "image": imageUrl })
  },
  "reviewRating": {
    "@type": "Rating",
    "ratingValue": normalizedRating.toFixed(1),
    "bestRating": "5",
    "worstRating": "1"
  },
  "author": {
    "@type": "Organization",
    "name": author
  },
  "publisher": {
    "@type": "Organization",
    "name": SITE_TITLE,
    "url": SITE_URL
  },
  "datePublished": datePublished.toISOString(),
  "reviewBody": reviewBody,
  "url": fullUrl
};

// Aggregate rating schema for showing star count
const aggregateSchema = {
  "@context": "https://schema.org",
  "@type": itemType,
  "name": itemName,
  "description": description,
  ...(imageUrl && { "image": imageUrl }),
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": normalizedRating.toFixed(1),
    "bestRating": "5",
    "worstRating": "1",
    "ratingCount": actualReviewCount,
    "reviewCount": actualReviewCount
  },
  "review": {
    "@type": "Review",
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": normalizedRating.toFixed(1),
      "bestRating": "5"
    },
    "author": {
      "@type": "Organization", 
      "name": author
    },
    "datePublished": datePublished.toISOString(),
    "reviewBody": reviewBody
  }
};
---

<script type="application/ld+json" set:html={JSON.stringify(schema)} />
<script type="application/ld+json" set:html={JSON.stringify(aggregateSchema)} />


