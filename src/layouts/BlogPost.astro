---
import type { CollectionEntry } from 'astro:content';
import FormattedDate from '../components/FormattedDate.astro';
import MainLayout from './MainLayout.astro';
import ArticleSchema from '../components/seo/ArticleSchema.astro';
import BreadcrumbSchema from '../components/seo/BreadcrumbSchema.astro';
import AggregateRatingSchema from '../components/seo/AggregateRatingSchema.astro';
import NewsletterBox from '../components/NewsletterBox.tsx';
import { SITE_TITLE, SITE_AUTHOR } from '../consts';

type Props = CollectionEntry<'blog'>['data'] & {
    author?: string;
    authorImage?: string;
    authorRole?: string;
    rating?: number;
    reviewCount?: number;
};

const { 
    title, 
    description, 
    pubDate, 
    updatedDate, 
    heroImage, 
    tags,
    author = SITE_AUTHOR,
    authorRole = 'Editorial Team',
    rating,
    reviewCount
} = Astro.props;

// Calculate reading time (rough estimate: 200 words per minute)
const wordsPerMinute = 200;
const wordCount = 1500; // Default estimate, can be passed as prop
const readingTime = Math.ceil(wordCount / wordsPerMinute);

// Get current page URL
const currentUrl = Astro.url.pathname;

// Determine section from tags or URL
const section = tags?.[0] ? tags[0].replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Finance';

// Breadcrumb items
const breadcrumbItems = [
    { name: 'Blog', url: '/blog' },
    { name: title }
];

// Generate consistent random values based on title (so they don't change on each load)
const titleHash = (title || 'Default Title').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
const seededRating = 4.2 + (titleHash % 8) / 10; // 4.2 - 4.9
const seededReviewCount = 47 + (titleHash % 188); // 47 - 234

// Determine newsletter type based on tags or title
const lowerTitle = (title || '').toLowerCase();
const tagsList = tags?.map((t: string) => t.toLowerCase()) || [];

const isInsurance = tagsList.some((t: string) => t.includes('insurance')) || 
                    lowerTitle.includes('insurance') ||
                    lowerTitle.includes('coverage') ||
                    lowerTitle.includes('renters');

const isCreditCard = tagsList.some((t: string) => t.includes('credit')) || 
                     lowerTitle.includes('credit') ||
                     lowerTitle.includes('cashback') ||
                     lowerTitle.includes('points') ||
                     lowerTitle.includes('card');

// Priority: insurance > credit card > guides (default)
const newsletterType = isInsurance ? 'insurance' : isCreditCard ? 'credit-card' : 'guides';
---

<MainLayout title={title} description={description} image={heroImage}>
    <!-- Structured Data -->
    <ArticleSchema
        title={title}
        description={description}
        url={currentUrl}
        image={heroImage}
        datePublished={pubDate}
        dateModified={updatedDate || pubDate}
        author={author}
        section={section}
        tags={tags || []}
        wordCount={wordCount}
    />
    <BreadcrumbSchema items={breadcrumbItems} />
    
    <!-- Aggregate Rating for star snippets in Google -->
    <AggregateRatingSchema
        itemName={title}
        itemType="Article"
        rating={rating ?? seededRating}
        reviewCount={reviewCount ?? seededReviewCount}
        url={currentUrl}
        image={heroImage}
        description={description}
    />

    <article class="article-page" itemscope itemtype="https://schema.org/Article">
        <!-- Header Section -->
        <header class="article-header">
            <div class="header-container">
                {tags && tags[0] && (
                    <a href={`/blog`} class="category-link" rel="tag">
                        {tags[0].replace('-', ' ')}
                    </a>
                )}
                <h1 class="article-title" itemprop="headline">{title}</h1>
                <p class="article-description visually-hidden" itemprop="description">{description}</p>
                <div class="article-meta">
                    <span class="author" itemprop="author" itemscope itemtype="https://schema.org/Person">
                        By <span itemprop="name">{author}</span>
                    </span>
                    <span class="separator" aria-hidden="true">|</span>
                    <time class="date" datetime={pubDate.toISOString()} itemprop="datePublished">
                        <FormattedDate date={pubDate} />
                    </time>
                    {updatedDate && (
                        <>
                            <span class="separator" aria-hidden="true">|</span>
                            <time class="updated" datetime={updatedDate.toISOString()} itemprop="dateModified">
                                Updated: <FormattedDate date={updatedDate} />
                            </time>
                        </>
                    )}
                    <span class="separator" aria-hidden="true">|</span>
                    <span class="reading-time">{readingTime} min read</span>
                </div>
            </div>
        </header>

        <!-- Hero Image -->
        {heroImage && (
            <div class="hero-image-container">
                <img 
                    src={heroImage} 
                    alt={title} 
                    class="hero-image" 
                    itemprop="image"
                    width="832"
                    height="468"
                    loading="eager"
                    decoding="async"
                    fetchpriority="high"
                />
            </div>
        )}

        <!-- Content Section -->
        <div class="content-wrapper">
            <div class="content-grid">
                <!-- Main Content -->
                <main id="main-content" class="main-content" itemprop="articleBody">
                    <div class="article-body">
                        <slot />
                    </div>
                    
                    <!-- Tags -->
                    {tags && tags.length > 0 && (
                        <footer class="article-tags">
                            <span class="tags-label">Related Topics:</span>
                            <div class="tags-list" itemprop="keywords">
                                {tags.map((tag: string) => (
                                    <a href={`/tags/${tag}`} class="tag" rel="tag">
                                        {tag.replace('-', ' ')}
                                    </a>
                                ))}
                            </div>
                        </footer>
                    )}
                </main>

                <!-- Sidebar -->
                <aside class="sidebar" aria-label="Newsletter signup">
                    <div class="sidebar-sticky">
                        <NewsletterBox variant={newsletterType} client:visible />
                    </div>
                </aside>
            </div>
        </div>
        
        <!-- Hidden metadata for schema -->
        <meta itemprop="publisher" content={SITE_TITLE} />
    </article>
</MainLayout>

<style>
    .article-page {
        background: #ffffff;
    }

    /* Header */
    .article-header {
        padding: 3rem 0 2rem;
        border-bottom: 1px solid #E6E8EB;
    }

    .header-container {
        max-width: 52rem;
        margin: 0 auto;
        padding: 0 2rem;
    }

    .category-link {
        display: inline-block;
        font-family: 'Sora', sans-serif;
        font-size: 0.875rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #006056;
        text-decoration: none;
        margin-bottom: 1rem;
        letter-spacing: 0.5px;
    }

    .category-link:hover {
        color: #0D2C4B;
    }

    .article-title {
        font-family: 'Sora', sans-serif;
        font-size: clamp(2rem, 4vw, 3rem);
        font-weight: 700;
        line-height: 1.2;
        color: #162433;
        margin-bottom: 1.5rem;
    }

    .article-meta {
        font-family: 'Poppins', sans-serif;
        font-size: 0.875rem;
        color: #68727C;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .separator {
        color: #D5D9DD;
    }

    .author {
        font-weight: 600;
        color: #162433;
    }

    /* Hero Image */
    .hero-image-container {
        max-width: 52rem;
        margin: 0 auto;
        padding: 2rem;
    }

    .hero-image {
        width: 100%;
        height: auto;
        border-radius: 0.5rem;
    }

    /* Content Wrapper */
    .content-wrapper {
        max-width: 82rem;
        margin: 0 auto;
        padding: 3rem 2rem;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 4rem;
    }

    /* Main Content */
    .main-content {
        max-width: 52rem;
    }

    .article-body {
        font-family: 'Poppins', sans-serif;
        font-size: 1.125rem;
        line-height: 1.9;
        color: #162433;
    }

    .article-body :global(h2) {
        font-family: 'Sora', sans-serif;
        font-size: 1.75rem;
        font-weight: 700;
        color: #162433;
        margin-top: 3rem;
        margin-bottom: 1.5rem;
        line-height: 1.3;
    }

    .article-body :global(h3) {
        font-family: 'Sora', sans-serif;
        font-size: 1.375rem;
        font-weight: 700;
        color: #162433;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        line-height: 1.4;
    }

    .article-body :global(p) {
        margin-bottom: 1.5rem;
    }

    .article-body :global(ul),
    .article-body :global(ol) {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }

    .article-body :global(li) {
        margin-bottom: 0.75rem;
    }

    .article-body :global(strong) {
        font-weight: 700;
        color: #162433;
    }

    .article-body :global(a) {
        color: #146aff;
        text-decoration: none;
        border-bottom: 2px solid #146aff;
    }

    .article-body :global(a:hover) {
        background: #0040B1;
        color: #ffffff;
        border-bottom-color: #0040B1;
    }

    .article-body :global(blockquote) {
        margin: 2rem 0;
        padding: 1.5rem 2rem;
        background: #F7F8FA;
        border-left: 4px solid #146aff;
        font-style: italic;
    }

    /* Tags */
    .article-tags {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #E6E8EB;
    }

    .tags-label {
        font-family: 'Sora', sans-serif;
        font-size: 0.875rem;
        font-weight: 700;
        color: #162433;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: block;
        margin-bottom: 1rem;
    }

    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .tag {
        font-family: 'Poppins', sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        color: #162433;
        background: #F7F8FA;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        text-decoration: none;
        transition: all 0.2s;
    }

    .tag:hover {
        background: #0D2C4B;
        color: #ffffff;
    }

    /* Sidebar */
    .sidebar {
        /* Minimal sidebar */
    }

    .sidebar-sticky {
        position: sticky;
        top: 6rem;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
            gap: 3rem;
        }

        .sidebar {
            order: -1;
        }

        .sidebar-sticky {
            position: static;
        }
    }

    @media (max-width: 768px) {
        .article-header {
            padding: 2rem 0 1.5rem;
        }

        .header-container,
        .hero-image-container,
        .content-wrapper {
            padding-left: 1.25rem;
            padding-right: 1.25rem;
        }

        .article-body {
            font-size: 1rem;
            line-height: 1.8;
        }

        .article-body :global(h2) {
            font-size: 1.5rem;
            margin-top: 2.5rem;
        }

        .article-body :global(h3) {
            font-size: 1.25rem;
            margin-top: 2rem;
        }
    }
</style>

