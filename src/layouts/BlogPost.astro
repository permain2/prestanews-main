---
import type { CollectionEntry } from 'astro:content';
import FormattedDate from '../components/FormattedDate.astro';
import MainLayout from './MainLayout.astro';
import ArticleSchema from '../components/seo/ArticleSchema.astro';
import BreadcrumbSchema from '../components/seo/BreadcrumbSchema.astro';
import AggregateRatingSchema from '../components/seo/AggregateRatingSchema.astro';
import AuthorBox from '../components/AuthorBox.astro';
import NewsletterBox from '../components/NewsletterBox.tsx';
import { SITE_TITLE, SITE_AUTHOR } from '../consts';

type Props = CollectionEntry<'blog'>['data'] & {
    author?: string;
    authorImage?: string;
    authorRole?: string;
    authorBio?: string;
    authorTwitter?: string;
    authorLinkedin?: string;
    rating?: number;
    reviewCount?: number;
};

const { 
    title, 
    description, 
    pubDate, 
    updatedDate, 
    heroImage, 
    tags,
    author = SITE_AUTHOR,
    authorImage = '/team/sarah-chen.jpg',
    authorRole = 'Editorial Team',
    authorBio,
    authorTwitter,
    authorLinkedin,
    rating,
    reviewCount
} = Astro.props;

// Author bios database
const authorBios: Record<string, { bio: string; twitter?: string; linkedin?: string; image: string; role: string }> = {
    'Sarah Chen': {
        bio: 'Sarah is a credit card and travel rewards expert with over 8 years of experience in personal finance. She has been featured in The Wall Street Journal, Forbes, and CNBC. Sarah personally holds and reviews many of the cards discussed on this site.',
        twitter: 'sarahchen_finance',
        linkedin: 'sarah-chen-finance',
        image: '/team/sarah-chen.jpg',
        role: 'Senior Rewards Strategist'
    },
    'David Kim': {
        bio: 'David is an insurance analyst specializing in auto, home, and life insurance. With 10+ years in the industry, he helps readers find the best coverage at the lowest prices. Previously worked at State Farm and Allstate.',
        linkedin: 'david-kim-insurance',
        image: '/team/david-kim.jpg',
        role: 'Insurance Analyst'
    },
    'Emily Johnson': {
        bio: 'Emily covers personal finance, banking, and credit scores. She holds a CFP® certification and previously worked as a financial advisor. Her work has appeared in NerdWallet, Bankrate, and Money Magazine.',
        twitter: 'emilyjohnson_money',
        linkedin: 'emily-johnson-cfp',
        image: '/team/emily-johnson.jpg',
        role: 'Certified Financial Planner'
    },
    'Michael Rodriguez': {
        bio: 'Michael is our travel editor with expertise in airline loyalty programs, hotel points, and award travel. He has visited 50+ countries and earned over 5 million points through strategic credit card use.',
        twitter: 'mike_travels',
        linkedin: 'michael-rodriguez-travel',
        image: '/team/michael-rodriguez.jpg',
        role: 'Travel Editor'
    },
    'Jessica Martinez': {
        bio: 'Jessica specializes in consumer protection, warranties, and financial technology. She holds a J.D. and previously worked in consumer advocacy. Her goal is helping readers understand their rights.',
        linkedin: 'jessica-martinez-jd',
        image: '/team/jessica-martinez.jpg',
        role: 'Consumer Rights Editor'
    },
    'Screened Editorial Team': {
        bio: 'Our editorial team consists of certified financial planners, insurance experts, and award travel specialists. We independently research, test, and recommend the best products. We may earn commission from partner links.',
        image: '/logo/screened-icon.png',
        role: 'Editorial Team'
    }
};

// Get author info
const authorInfo = authorBios[author] || authorBios['Screened Editorial Team'];
const finalAuthorImage = authorImage || authorInfo.image;
const finalAuthorRole = authorRole || authorInfo.role;
const finalAuthorBio = authorBio || authorInfo.bio;
const finalAuthorTwitter = authorTwitter || authorInfo.twitter;
const finalAuthorLinkedin = authorLinkedin || authorInfo.linkedin;

// Calculate reading time (rough estimate: 200 words per minute)
const wordsPerMinute = 200;
const wordCount = 1500; // Default estimate, can be passed as prop
const readingTime = Math.ceil(wordCount / wordsPerMinute);

// Get current page URL
const currentUrl = Astro.url.pathname;

// Determine section from tags or URL
const section = tags?.[0] ? tags[0].replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Finance';

// Breadcrumb items
const breadcrumbItems = [
    { name: 'Blog', url: '/blog' },
    { name: title }
];

// Generate consistent random values based on title (so they don't change on each load)
const titleHash = (title || 'Default Title').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
const seededRating = 4.2 + (titleHash % 8) / 10; // 4.2 - 4.9
const seededReviewCount = 47 + (titleHash % 188); // 47 - 234

// Determine newsletter type based on tags or title
const lowerTitle = (title || '').toLowerCase();
const tagsList = tags?.map((t: string) => t.toLowerCase()) || [];

const isInsurance = tagsList.some((t: string) => t.includes('insurance')) || 
                    lowerTitle.includes('insurance') ||
                    lowerTitle.includes('coverage') ||
                    lowerTitle.includes('renters');

const isCreditCard = tagsList.some((t: string) => t.includes('credit')) || 
                     lowerTitle.includes('credit') ||
                     lowerTitle.includes('cashback') ||
                     lowerTitle.includes('points') ||
                     lowerTitle.includes('card');

// Priority: insurance > credit card > guides (default)
const newsletterType = isInsurance ? 'insurance' : isCreditCard ? 'credit-card' : 'guides';
---

<MainLayout title={title} description={description} image={heroImage}>
    <!-- Structured Data -->
    <ArticleSchema
        title={title}
        description={description}
        url={currentUrl}
        image={heroImage}
        datePublished={pubDate}
        dateModified={updatedDate || pubDate}
        author={author}
        section={section}
        tags={tags || []}
        wordCount={wordCount}
    />
    <BreadcrumbSchema items={breadcrumbItems} />
    
    <!-- Aggregate Rating for star snippets in Google -->
    <AggregateRatingSchema
        itemName={title}
        itemType="Article"
        rating={rating ?? seededRating}
        reviewCount={reviewCount ?? seededReviewCount}
        url={currentUrl}
        image={heroImage}
        description={description}
    />

    <article class="article-page" itemscope itemtype="https://schema.org/Article">
        <!-- Header Section -->
        <header class="article-header">
            <div class="header-container">
                {tags && tags[0] && (
                    <a href={`/blog`} class="category-link" rel="tag">
                        {tags[0].replace('-', ' ')}
                    </a>
                )}
                <h1 class="article-title" itemprop="headline">{title}</h1>
                <p class="article-description visually-hidden" itemprop="description">{description}</p>
                <div class="article-meta">
                    <span class="author" itemprop="author" itemscope itemtype="https://schema.org/Person">
                        By <span itemprop="name">{author}</span>
                    </span>
                    <span class="separator" aria-hidden="true">|</span>
                    <time class="date" datetime={pubDate.toISOString()} itemprop="datePublished">
                        <FormattedDate date={pubDate} />
                    </time>
                    {updatedDate && (
                        <>
                            <span class="separator" aria-hidden="true">|</span>
                            <time class="updated" datetime={updatedDate.toISOString()} itemprop="dateModified">
                                Updated: <FormattedDate date={updatedDate} />
                            </time>
                        </>
                    )}
                    <span class="separator" aria-hidden="true">|</span>
                    <span class="reading-time">{readingTime} min read</span>
                </div>
            </div>
        </header>

        <!-- Hero Image -->
        {heroImage && (
            <div class="hero-image-container">
                <img 
                    src={heroImage} 
                    alt={title} 
                    class="hero-image" 
                    itemprop="image"
                    width="832"
                    height="468"
                    loading="eager"
                    decoding="async"
                    fetchpriority="high"
                />
            </div>
        )}

        <!-- Content Section -->
        <div class="content-wrapper">
            <div class="content-grid">
                <!-- Main Content -->
                <main id="main-content" class="main-content" itemprop="articleBody">
                    <div class="article-body article-content">
                        <slot />
                    </div>
                    
                    <!-- Tags -->
                    {tags && tags.length > 0 && (
                        <footer class="article-tags">
                            <span class="tags-label">Related Topics:</span>
                            <div class="tags-list" itemprop="keywords">
                                {tags.map((tag: string) => (
                                    <a href={`/tags/${tag}`} class="tag" rel="tag">
                                        {tag.replace('-', ' ')}
                                    </a>
                                ))}
                            </div>
                        </footer>
                    )}

                    <!-- Author Box -->
                    <div class="author-section">
                        <h3 class="author-section-title">About the Author</h3>
                        <AuthorBox 
                            name={author}
                            role={finalAuthorRole}
                            image={finalAuthorImage}
                            bio={finalAuthorBio}
                            twitter={finalAuthorTwitter}
                            linkedin={finalAuthorLinkedin}
                        />
                    </div>

                    <!-- Last Updated Notice -->
                    <div class="update-notice">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span>
                            This article was last reviewed and updated on <strong><FormattedDate date={updatedDate || pubDate} /></strong> to ensure accuracy and reflect the latest information.
                        </span>
                    </div>

                    <!-- Related Articles -->
                    <div class="related-section">
                        <h3 class="related-title">Continue Reading</h3>
                        <div class="related-links">
                            {isCreditCard && (
                                <>
                                    <a href="/credit-cards/best-travel-cards">→ Best Travel Credit Cards</a>
                                    <a href="/credit-cards/best-cashback">→ Best Cash Back Cards</a>
                                    <a href="/blog/credit-card-points">→ Credit Card Points Guide</a>
                                </>
                            )}
                            {isInsurance && (
                                <>
                                    <a href="/insurance/car">→ Best Car Insurance</a>
                                    <a href="/insurance/home">→ Best Home Insurance</a>
                                    <a href="/insurance/life">→ Best Life Insurance</a>
                                </>
                            )}
                            {!isCreditCard && !isInsurance && (
                                <>
                                    <a href="/credit-cards">→ Credit Card Reviews</a>
                                    <a href="/insurance">→ Insurance Guides</a>
                                    <a href="/blog">→ All Articles</a>
                                </>
                            )}
                        </div>
                    </div>
                </main>

                <!-- Sidebar -->
                <aside class="sidebar" aria-label="Newsletter signup">
                    <div class="sidebar-sticky">
                        <NewsletterBox variant={newsletterType} client:visible />
                    </div>
                </aside>
            </div>
        </div>
        
        <!-- Hidden metadata for schema -->
        <meta itemprop="publisher" content={SITE_TITLE} />
    </article>
</MainLayout>

<style>
    .article-page {
        background: #ffffff;
    }

    /* Header */
    .article-header {
        padding: 3rem 0 2rem;
        border-bottom: 1px solid #E6E8EB;
    }

    .header-container {
        max-width: 52rem;
        margin: 0 auto;
        padding: 0 2rem;
    }

    .category-link {
        display: inline-block;
        font-family: 'Sora', sans-serif;
        font-size: 0.875rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #006056;
        text-decoration: none;
        margin-bottom: 1rem;
        letter-spacing: 0.5px;
    }

    .category-link:hover {
        color: #0D2C4B;
    }

    .article-title {
        font-family: 'Sora', sans-serif;
        font-size: clamp(2rem, 4vw, 3rem);
        font-weight: 700;
        line-height: 1.2;
        color: #162433;
        margin-bottom: 1.5rem;
    }

    .article-meta {
        font-family: 'Poppins', sans-serif;
        font-size: 0.875rem;
        color: #68727C;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .separator {
        color: #D5D9DD;
    }

    .author {
        font-weight: 600;
        color: #162433;
    }

    /* Hero Image */
    .hero-image-container {
        max-width: 52rem;
        margin: 0 auto;
        padding: 2rem;
    }

    .hero-image {
        width: 100%;
        height: auto;
        border-radius: 0.5rem;
    }

    /* Content Wrapper */
    .content-wrapper {
        max-width: 82rem;
        margin: 0 auto;
        padding: 3rem 2rem;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 4rem;
    }

    /* Main Content */
    .main-content {
        max-width: 52rem;
    }

    .article-body {
        font-family: 'Poppins', sans-serif;
        font-size: 1.125rem;
        line-height: 1.9;
        color: #162433;
    }

    .article-body :global(h2) {
        font-family: 'Sora', sans-serif;
        font-size: 1.75rem;
        font-weight: 700;
        color: #162433;
        margin-top: 3rem;
        margin-bottom: 1.5rem;
        line-height: 1.3;
    }

    .article-body :global(h3) {
        font-family: 'Sora', sans-serif;
        font-size: 1.375rem;
        font-weight: 700;
        color: #162433;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        line-height: 1.4;
    }

    .article-body :global(p) {
        margin-bottom: 1.5rem;
    }

    .article-body :global(ul),
    .article-body :global(ol) {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }

    .article-body :global(li) {
        margin-bottom: 0.75rem;
    }

    .article-body :global(strong) {
        font-weight: 700;
        color: #162433;
    }

    .article-body :global(a) {
        color: #146aff;
        text-decoration: none;
        border-bottom: 2px solid #146aff;
    }

    .article-body :global(a:hover) {
        background: #0040B1;
        color: #ffffff;
        border-bottom-color: #0040B1;
    }

    .article-body :global(blockquote) {
        margin: 2rem 0;
        padding: 1.5rem 2rem;
        background: #F7F8FA;
        border-left: 4px solid #146aff;
        font-style: italic;
    }

    /* Tags */
    .article-tags {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #E6E8EB;
    }

    .tags-label {
        font-family: 'Sora', sans-serif;
        font-size: 0.875rem;
        font-weight: 700;
        color: #162433;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: block;
        margin-bottom: 1rem;
    }

    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .tag {
        font-family: 'Poppins', sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        color: #162433;
        background: #F7F8FA;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        text-decoration: none;
        transition: all 0.2s;
    }

    .tag:hover {
        background: #0D2C4B;
        color: #ffffff;
    }

    /* Author Section */
    .author-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #E6E8EB;
    }

    .author-section-title {
        font-family: 'Sora', sans-serif;
        font-size: 1rem;
        font-weight: 700;
        color: #162433;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
    }

    /* Update Notice - Motion.dev style */
    .update-notice {
        display: flex;
        align-items: flex-start;
        gap: 0.875rem;
        margin-top: 2rem;
        padding: 1.25rem 1.5rem;
        background: #f8fafc;
        border-radius: 16px;
        font-size: 0.875rem;
        color: #475569;
        box-shadow: 
            0 0 0 1px rgba(0, 0, 0, 0.03),
            0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .update-notice svg {
        flex-shrink: 0;
        margin-top: 2px;
        stroke: #3b82f6;
    }

    .update-notice strong {
        color: #0f172a;
        font-weight: 600;
    }

    /* Related Section - Motion.dev style */
    .related-section {
        margin-top: 2.5rem;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 16px;
        box-shadow: 
            0 0 0 1px rgba(0, 0, 0, 0.03),
            0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .related-title {
        font-family: 'Sora', sans-serif;
        font-size: 1rem;
        font-weight: 700;
        color: #162433;
        margin-bottom: 1rem;
    }

    .related-links {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .related-links a {
        font-family: 'Poppins', sans-serif;
        font-size: 0.9375rem;
        color: #3B82F6;
        text-decoration: none;
        transition: color 0.2s;
    }

    .related-links a:hover {
        color: #1D4ED8;
        text-decoration: underline;
    }

    /* Sidebar */
    .sidebar {
        /* Minimal sidebar */
    }

    .sidebar-sticky {
        position: sticky;
        top: 6rem;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
            gap: 3rem;
        }

        .sidebar {
            order: -1;
        }

        .sidebar-sticky {
            position: static;
        }
    }

    @media (max-width: 768px) {
        .article-header {
            padding: 2rem 0 1.5rem;
        }

        .header-container,
        .hero-image-container,
        .content-wrapper {
            padding-left: 1.25rem;
            padding-right: 1.25rem;
        }

        .article-body {
            font-size: 1rem;
            line-height: 1.8;
        }

        .article-body :global(h2) {
            font-size: 1.5rem;
            margin-top: 2.5rem;
        }

        .article-body :global(h3) {
            font-size: 1.25rem;
            margin-top: 2rem;
        }
    }
</style>

