---
import type { CollectionEntry } from 'astro:content';
import FormattedDate from '../components/FormattedDate.astro';
import MainLayout from './MainLayout.astro';
import ArticleSchema from '../components/seo/ArticleSchema.astro';
import BreadcrumbSchema from '../components/seo/BreadcrumbSchema.astro';
import AggregateRatingSchema from '../components/seo/AggregateRatingSchema.astro';
import { SITE_TITLE, SITE_AUTHOR } from '../consts';

type Props = CollectionEntry<'blog'>['data'] & {
    author?: string;
    authorImage?: string;
    authorRole?: string;
    rating?: number;
    reviewCount?: number;
};

const { 
    title, 
    description, 
    pubDate, 
    updatedDate, 
    heroImage, 
    tags,
    author = SITE_AUTHOR,
    authorRole = 'Editorial Team',
    rating,
    reviewCount
} = Astro.props;

// Calculate reading time (rough estimate: 200 words per minute)
const wordsPerMinute = 200;
const wordCount = 1500; // Default estimate, can be passed as prop
const readingTime = Math.ceil(wordCount / wordsPerMinute);

// Get current page URL
const currentUrl = Astro.url.pathname;

// Determine section from tags or URL
const section = tags?.[0] ? tags[0].replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Finance';

// Breadcrumb items
const breadcrumbItems = [
    { name: 'News', url: '/news' },
    { name: title }
];

// Generate consistent random values based on title (so they don't change on each load)
const titleHash = title.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
const seededRating = 4.2 + (titleHash % 8) / 10; // 4.2 - 4.9
const seededReviewCount = 47 + (titleHash % 188); // 47 - 234

// Determine newsletter type based on tags or title
const lowerTitle = title.toLowerCase();
const tagsList = tags?.map((t: string) => t.toLowerCase()) || [];

const isInsurance = tagsList.some((t: string) => t.includes('insurance')) || 
                    lowerTitle.includes('insurance') ||
                    lowerTitle.includes('coverage') ||
                    lowerTitle.includes('renters');

const isCreditCard = tagsList.some((t: string) => t.includes('credit')) || 
                     lowerTitle.includes('credit') ||
                     lowerTitle.includes('cashback') ||
                     lowerTitle.includes('points') ||
                     lowerTitle.includes('card');

// Priority: insurance > credit card > guides (default)
const newsletterType = isInsurance ? 'insurance' : isCreditCard ? 'credit-card' : 'guides';
---

<MainLayout title={title} description={description} image={heroImage}>
    <!-- Structured Data -->
    <ArticleSchema
        title={title}
        description={description}
        url={currentUrl}
        image={heroImage}
        datePublished={pubDate}
        dateModified={updatedDate || pubDate}
        author={author}
        section={section}
        tags={tags || []}
        wordCount={wordCount}
    />
    <BreadcrumbSchema items={breadcrumbItems} />
    
    <!-- Aggregate Rating for star snippets in Google -->
    <AggregateRatingSchema
        itemName={title}
        itemType="Article"
        rating={rating ?? seededRating}
        reviewCount={reviewCount ?? seededReviewCount}
        url={currentUrl}
        image={heroImage}
        description={description}
    />

    <article class="article-page" itemscope itemtype="https://schema.org/Article">
        <!-- Header Section -->
        <header class="article-header">
            <div class="header-container">
                {tags && tags[0] && (
                    <a href={`/news/${tags[0]}`} class="category-link" rel="tag">
                        {tags[0].replace('-', ' ')}
                    </a>
                )}
                <h1 class="article-title" itemprop="headline">{title}</h1>
                <p class="article-description visually-hidden" itemprop="description">{description}</p>
                <div class="article-meta">
                    <span class="author" itemprop="author" itemscope itemtype="https://schema.org/Person">
                        By <span itemprop="name">{author}</span>
                    </span>
                    <span class="separator" aria-hidden="true">|</span>
                    <time class="date" datetime={pubDate.toISOString()} itemprop="datePublished">
                        <FormattedDate date={pubDate} />
                    </time>
                    {updatedDate && (
                        <>
                            <span class="separator" aria-hidden="true">|</span>
                            <time class="updated" datetime={updatedDate.toISOString()} itemprop="dateModified">
                                Updated: <FormattedDate date={updatedDate} />
                            </time>
                        </>
                    )}
                    <span class="separator" aria-hidden="true">|</span>
                    <span class="reading-time">{readingTime} min read</span>
                </div>
            </div>
        </header>

        <!-- Hero Image -->
        {heroImage && (
            <div class="hero-image-container">
                <img 
                    src={heroImage} 
                    alt={title} 
                    class="hero-image" 
                    itemprop="image"
                    width="832"
                    height="468"
                    loading="eager"
                    decoding="async"
                    fetchpriority="high"
                />
            </div>
        )}

        <!-- Content Section -->
        <div class="content-wrapper">
            <div class="content-grid">
                <!-- Main Content -->
                <main id="main-content" class="main-content" itemprop="articleBody">
                    <div class="article-body">
                        <slot />
                    </div>
                    
                    <!-- Tags -->
                    {tags && tags.length > 0 && (
                        <footer class="article-tags">
                            <span class="tags-label">Related Topics:</span>
                            <div class="tags-list" itemprop="keywords">
                                {tags.map((tag: string) => (
                                    <a href={`/tags/${tag}`} class="tag" rel="tag">
                                        {tag.replace('-', ' ')}
                                    </a>
                                ))}
                            </div>
                        </footer>
                    )}
                </main>

                <!-- Sidebar -->
                <aside class="sidebar" aria-label="Newsletter signup">
                    <div class="sidebar-sticky">
                        
                        {/* GUIDES NEWSLETTER - Opening Envelope */}
                        {newsletterType === 'guides' && (
                        <div class="newsletter-box">
                            <div class="envelope-wrap">
                                <svg class="envelope-svg" viewBox="0 0 48 48" fill="none">
                                    <rect class="env-body" x="4" y="14" width="40" height="28" rx="3" fill="#1a3a5c"/>
                                    <path class="env-flap" d="M4 17C4 15.34 5.34 14 7 14H41C42.66 14 44 15.34 44 17L24 32L4 17Z" fill="#0D2C4B"/>
                                    <rect class="env-letter" x="10" y="6" width="28" height="24" rx="2" fill="#fff"/>
                                    <line class="env-line" x1="14" y1="12" x2="34" y2="12" stroke="#e5e7eb" stroke-width="2"/>
                                    <line class="env-line" x1="14" y1="18" x2="30" y2="18" stroke="#e5e7eb" stroke-width="2"/>
                                    <line class="env-line" x1="14" y1="24" x2="26" y2="24" stroke="#e5e7eb" stroke-width="2"/>
                                </svg>
                            </div>
                            <p class="box-headline">Get the <strong>Money Cheat Sheet</strong></p>
                            <p class="box-sub">Weekly tips to save $1,000+/year</p>
                            <form class="box-form" id="newsletter-form">
                                <input type="email" placeholder="Email" required />
                                <button type="submit">FREE</button>
                            </form>
                            <p class="box-proof">‚úì 12,847 readers</p>
                        </div>
                        )}

                        {/* CREDIT CARD NEWSLETTER */}
                        {newsletterType === 'credit-card' && (
                        <div class="newsletter-box newsletter-cc">
                            <div class="cc-chip-mini">
                                <svg viewBox="0 0 32 24"><rect x="0" y="2" width="32" height="18" rx="2" fill="#C9A227"/><rect x="3" y="6" width="5" height="2.5" fill="#A67C00"/><rect x="3" y="10" width="5" height="2.5" fill="#A67C00"/><rect x="3" y="14" width="5" height="2.5" fill="#A67C00"/><rect x="10" y="6" width="5" height="2.5" fill="#A67C00"/><rect x="10" y="10" width="5" height="2.5" fill="#A67C00"/><rect x="10" y="14" width="5" height="2.5" fill="#A67C00"/><rect x="17" y="6" width="5" height="10.5" fill="#A67C00"/><rect x="24" y="6" width="5" height="2.5" fill="#A67C00"/><rect x="24" y="10" width="5" height="2.5" fill="#A67C00"/><rect x="24" y="14" width="5" height="2.5" fill="#A67C00"/></svg>
                            </div>
                            <p class="box-headline">Get the <strong>$2,500 Card Guide</strong></p>
                            <p class="box-sub">Best cards for max rewards (2025)</p>
                            <ul class="box-list">
                                <li>üí≥ Top bonus offers this month</li>
                                <li>üìä Point valuations cheat sheet</li>
                                <li>üéØ Card matching quiz</li>
                            </ul>
                            <form class="box-form" id="newsletter-form">
                                <input type="email" placeholder="Email" required />
                                <button type="submit">FREE</button>
                            </form>
                            <p class="box-proof">‚úì 12,847 cardholders</p>
                        </div>
                        )}

                        {/* INSURANCE NEWSLETTER */}
                        {newsletterType === 'insurance' && (
                        <div class="newsletter-box newsletter-ins">
                            <div class="shield-mini">
                                <svg viewBox="0 0 32 38" fill="none">
                                    <path d="M16 2L4 8V18C4 28 10 34 16 36C22 34 28 28 28 18V8L16 2Z" fill="#146aff"/>
                                    <path d="M12 19L15 22L21 15" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <p class="box-headline">Get the <strong>$1,200 Savings Guide</strong></p>
                            <p class="box-sub">Cut your premiums in half</p>
                            <ul class="box-list">
                                <li>üöó Auto rate comparison sheet</li>
                                <li>üè† Home coverage checklist</li>
                                <li>üí∞ Hidden discount codes</li>
                            </ul>
                            <form class="box-form" id="newsletter-form">
                                <input type="email" placeholder="Email" required />
                                <button type="submit">FREE</button>
                            </form>
                            <p class="box-proof">‚úì 8,234 protected readers</p>
                        </div>
                        )}

                    </div>
                </aside>
            </div>
        </div>
        
        <!-- Hidden metadata for schema -->
        <meta itemprop="publisher" content={SITE_TITLE} />
    </article>
</MainLayout>

<style>
    .article-page {
        background: #ffffff;
    }

    /* Header */
    .article-header {
        padding: 3rem 0 2rem;
        border-bottom: 1px solid #E6E8EB;
    }

    .header-container {
        max-width: 52rem;
        margin: 0 auto;
        padding: 0 2rem;
    }

    .category-link {
        display: inline-block;
        font-family: 'Sora', sans-serif;
        font-size: 0.875rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #006056;
        text-decoration: none;
        margin-bottom: 1rem;
        letter-spacing: 0.5px;
    }

    .category-link:hover {
        color: #0D2C4B;
    }

    .article-title {
        font-family: 'Sora', sans-serif;
        font-size: clamp(2rem, 4vw, 3rem);
        font-weight: 700;
        line-height: 1.2;
        color: #162433;
        margin-bottom: 1.5rem;
    }

    .article-meta {
        font-family: 'Poppins', sans-serif;
        font-size: 0.875rem;
        color: #68727C;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .separator {
        color: #D5D9DD;
    }

    .author {
        font-weight: 600;
        color: #162433;
    }

    /* Hero Image */
    .hero-image-container {
        max-width: 52rem;
        margin: 0 auto;
        padding: 2rem;
    }

    .hero-image {
        width: 100%;
        height: auto;
        border-radius: 0.5rem;
    }

    /* Content Wrapper */
    .content-wrapper {
        max-width: 82rem;
        margin: 0 auto;
        padding: 3rem 2rem;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 4rem;
    }

    /* Main Content */
    .main-content {
        max-width: 52rem;
    }

    .article-body {
        font-family: 'Poppins', sans-serif;
        font-size: 1.125rem;
        line-height: 1.9;
        color: #162433;
    }

    .article-body :global(h2) {
        font-family: 'Sora', sans-serif;
        font-size: 1.75rem;
        font-weight: 700;
        color: #162433;
        margin-top: 3rem;
        margin-bottom: 1.5rem;
        line-height: 1.3;
    }

    .article-body :global(h3) {
        font-family: 'Sora', sans-serif;
        font-size: 1.375rem;
        font-weight: 700;
        color: #162433;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        line-height: 1.4;
    }

    .article-body :global(p) {
        margin-bottom: 1.5rem;
    }

    .article-body :global(ul),
    .article-body :global(ol) {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }

    .article-body :global(li) {
        margin-bottom: 0.75rem;
    }

    .article-body :global(strong) {
        font-weight: 700;
        color: #162433;
    }

    .article-body :global(a) {
        color: #146aff;
        text-decoration: none;
        border-bottom: 2px solid #146aff;
    }

    .article-body :global(a:hover) {
        background: #0040B1;
        color: #ffffff;
        border-bottom-color: #0040B1;
    }

    .article-body :global(blockquote) {
        margin: 2rem 0;
        padding: 1.5rem 2rem;
        background: #F7F8FA;
        border-left: 4px solid #146aff;
        font-style: italic;
    }

    /* Tags */
    .article-tags {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #E6E8EB;
    }

    .tags-label {
        font-family: 'Sora', sans-serif;
        font-size: 0.875rem;
        font-weight: 700;
        color: #162433;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: block;
        margin-bottom: 1rem;
    }

    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .tag {
        font-family: 'Poppins', sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        color: #162433;
        background: #F7F8FA;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        text-decoration: none;
        transition: all 0.2s;
    }

    .tag:hover {
        background: #0D2C4B;
        color: #ffffff;
    }

    /* Sidebar */
    .sidebar {
        /* Minimal sidebar */
    }

    .sidebar-sticky {
        position: sticky;
        top: 6rem;
    }

    /* ========================================
       NEWSLETTER BOX - Clean, Compact Design
       ======================================== */
    .newsletter-box {
        background: linear-gradient(180deg, #0D2C4B 0%, #091E32 100%);
        border-radius: 0.75rem;
        padding: 1.25rem;
        text-align: center;
        border: 1px solid rgba(20, 106, 255, 0.12);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .newsletter-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(13, 44, 75, 0.3);
    }

    /* Icon Wrappers */
    .envelope-wrap,
    .cc-chip-mini,
    .shield-mini {
        width: 40px;
        height: 40px;
        margin: 0 auto 0.75rem;
    }

    .envelope-svg {
        width: 100%;
        height: 100%;
    }

    .env-flap {
        transform-origin: 24px 14px;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .env-letter {
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s;
    }

    .env-line {
        opacity: 0;
        transition: opacity 0.3s ease 0.2s;
    }

    .newsletter-box:hover .env-flap {
        transform: rotateX(-180deg);
    }

    .newsletter-box:hover .env-letter {
        transform: translateY(-10px);
    }

    .newsletter-box:hover .env-line {
        opacity: 1;
    }

    .cc-chip-mini svg,
    .shield-mini svg {
        width: 100%;
        height: 100%;
    }

    /* Headlines */
    .box-headline {
        font-family: 'Poppins', sans-serif;
        font-size: 0.9375rem;
        color: #ffffff;
        margin-bottom: 0.25rem;
        line-height: 1.3;
    }

    .box-headline strong {
        color: #60a5fa;
        font-weight: 700;
    }

    .box-sub {
        font-family: 'Poppins', sans-serif;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 0.875rem;
    }

    /* List */
    .box-list {
        list-style: none;
        padding: 0;
        margin: 0 0 0.875rem 0;
        text-align: left;
    }

    .box-list li {
        font-family: 'Poppins', sans-serif;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.75);
        padding: 0.375rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        opacity: 0.8;
        transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .box-list li:last-child {
        border-bottom: none;
    }

    .newsletter-box:hover .box-list li {
        opacity: 1;
    }

    .newsletter-box:hover .box-list li:nth-child(1) { transform: translateX(3px); transition-delay: 0s; }
    .newsletter-box:hover .box-list li:nth-child(2) { transform: translateX(3px); transition-delay: 0.03s; }
    .newsletter-box:hover .box-list li:nth-child(3) { transform: translateX(3px); transition-delay: 0.06s; }

    /* Form */
    .box-form {
        display: flex;
        gap: 0.5rem;
    }

    .box-form input {
        flex: 1;
        min-width: 0;
        padding: 0.625rem 0.75rem;
        font-family: 'Poppins', sans-serif;
        font-size: 0.8125rem;
        color: #ffffff;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.375rem;
        outline: none;
        transition: border-color 0.2s ease;
    }

    .box-form input::placeholder {
        color: rgba(255, 255, 255, 0.35);
    }

    .box-form input:focus {
        border-color: #146aff;
    }

    .box-form button {
        padding: 0.625rem 1rem;
        font-family: 'Poppins', sans-serif;
        font-size: 0.75rem;
        font-weight: 700;
        color: #ffffff;
        background: #146aff;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background 0.2s ease;
        white-space: nowrap;
    }

    .box-form button:hover {
        background: #0040B1;
    }

    /* Social Proof */
    .box-proof {
        font-family: 'Poppins', sans-serif;
        font-size: 0.6875rem;
        color: rgba(255, 255, 255, 0.45);
        margin-top: 0.625rem;
    }

    /* Credit Card Variant */
    .newsletter-cc .cc-chip-mini {
        width: 32px;
        height: 24px;
    }

    .newsletter-cc .box-headline strong {
        color: #fbbf24;
    }

    .newsletter-cc .box-form button {
        background: #C9A227;
        color: #0D2C4B;
    }

    .newsletter-cc .box-form button:hover {
        background: #d4af37;
    }

    /* Insurance Variant */
    .newsletter-ins .shield-mini {
        width: 32px;
        height: 38px;
    }

    .newsletter-ins .box-headline strong {
        color: #34d399;
    }

    /* Mobile */
    @media (max-width: 1024px) {
        .newsletter-box {
            max-width: 300px;
            margin: 0 auto;
        }
    }

    @media (max-width: 480px) {
        .newsletter-box {
            padding: 1rem;
        }
        
        .box-headline {
            font-size: 0.875rem;
        }
        
        .box-form input {
            padding: 0.5rem 0.625rem;
            font-size: 0.75rem;
        }
        
        .box-form button {
            padding: 0.5rem 0.75rem;
            font-size: 0.6875rem;
        }
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
            gap: 3rem;
        }

        .sidebar {
            order: -1;
        }

        .sidebar-sticky {
            position: static;
        }
    }

    @media (max-width: 768px) {
        .article-header {
            padding: 2rem 0 1.5rem;
        }

        .header-container,
        .hero-image-container,
        .content-wrapper {
            padding-left: 1.25rem;
            padding-right: 1.25rem;
        }

        .article-body {
            font-size: 1rem;
            line-height: 1.8;
        }

        .article-body :global(h2) {
            font-size: 1.5rem;
            margin-top: 2.5rem;
        }

        .article-body :global(h3) {
            font-size: 1.25rem;
            margin-top: 2rem;
        }
    }
</style>

<script>
    // Newsletter form submission
    const form = document.getElementById('newsletter-form');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button');
            const input = form.querySelector('input') as HTMLInputElement;
            
            if (btn && input && input.value) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '...';
                btn.disabled = true;
                input.disabled = true;
                
                try {
                    const response = await fetch('/api/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: input.value,
                            source: 'guide-sidebar'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        btn.innerHTML = '‚úì';
                        btn.style.background = '#10b981';
                        input.value = '';
                        input.placeholder = 'Subscribed!';
                    } else {
                        btn.innerHTML = '‚úó';
                        btn.style.background = '#ef4444';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '';
                            btn.disabled = false;
                            input.disabled = false;
                        }, 2000);
                    }
                } catch (error) {
                    btn.innerHTML = '‚úó';
                    btn.style.background = '#ef4444';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                        input.disabled = false;
                    }, 2000);
                }
            }
        });
    }
</script>
