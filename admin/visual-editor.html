<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Editor - Screened</title>
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --black: #0f172a;
      --dark-gray: #475569;
      --mid-gray: #64748b;
      --light-gray: #94a3b8;
      --border: #e2e8f0;
      --background: #f8fafc;
      --white: #ffffff;
      --accent: #3b82f6;
      --success: #22c55e;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--background);
      overflow: hidden;
    }
    
    /* Top Toolbar */
    .top-toolbar {
      height: 56px;
      background: var(--white);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
    
    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--black);
      text-decoration: none;
    }
    
    .logo svg {
      width: 28px;
      height: 28px;
    }
    
    .nav-tabs {
      display: flex;
      gap: 0.25rem;
      margin-left: 1.5rem;
    }
    
    .nav-tab {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 0.875rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--dark-gray);
      text-decoration: none;
      transition: all 0.15s ease;
    }
    
    .nav-tab:hover {
      background: var(--background);
      color: var(--black);
    }
    
    .nav-tab.active {
      background: var(--black);
      color: var(--white);
    }
    
    .toolbar-center {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .site-selector {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .site-selector label {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--mid-gray);
    }
    
    .site-selector select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      background: var(--white);
      min-width: 160px;
    }
    
    .device-buttons {
      display: flex;
      gap: 0.25rem;
      background: var(--background);
      padding: 0.25rem;
      border-radius: 8px;
      margin-left: 1rem;
    }
    
    .device-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 32px;
      border-radius: 6px;
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--mid-gray);
      transition: all 0.15s ease;
    }
    
    .device-btn:hover {
      color: var(--black);
    }
    
    .device-btn.active {
      background: var(--white);
      color: var(--black);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 0.875rem;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s ease;
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--dark-gray);
    }
    
    .btn-ghost:hover {
      background: var(--background);
      color: var(--black);
    }
    
    .btn-secondary {
      background: var(--white);
      color: var(--black);
      border-color: var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--background);
    }
    
    .btn-primary {
      background: var(--black);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background: #1e293b;
    }
    
    .btn-success {
      background: var(--success);
      color: var(--white);
    }
    
    .btn-success:hover {
      background: #16a34a;
    }
    
    .divider {
      width: 1px;
      height: 24px;
      background: var(--border);
      margin: 0 0.5rem;
    }
    
    /* Main Editor Layout */
    .editor-container {
      display: flex;
      height: calc(100vh - 56px);
      margin-top: 56px;
    }
    
    /* Left Panel - Blocks */
    .left-panel {
      width: 260px;
      background: var(--white);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .panel-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--black);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .panel-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }
    
    .panel-tab {
      flex: 1;
      padding: 0.75rem;
      text-align: center;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--mid-gray);
      border: none;
      background: transparent;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s ease;
    }
    
    .panel-tab:hover {
      color: var(--black);
    }
    
    .panel-tab.active {
      color: var(--black);
      border-bottom-color: var(--black);
    }
    
    .blocks-container {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
    }
    
    .layers-container {
      flex: 1;
      overflow-y: auto;
      display: none;
    }
    
    .layers-container.active {
      display: block;
    }
    
    .blocks-container.active {
      display: block;
    }
    
    /* Canvas */
    .canvas-container {
      flex: 1;
      background: #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    #gjs {
      flex: 1;
      overflow: hidden;
    }
    
    /* Right Panel - Styles */
    .right-panel {
      width: 280px;
      background: var(--white);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .style-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }
    
    .style-tab {
      flex: 1;
      padding: 0.75rem;
      text-align: center;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--mid-gray);
      border: none;
      background: transparent;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s ease;
    }
    
    .style-tab:hover {
      color: var(--black);
    }
    
    .style-tab.active {
      color: var(--black);
      border-bottom-color: var(--black);
    }
    
    .style-container {
      flex: 1;
      overflow-y: auto;
    }
    
    /* GrapeJS Overrides */
    .gjs-one-bg {
      background-color: var(--white) !important;
    }
    
    .gjs-two-color {
      color: var(--dark-gray) !important;
    }
    
    .gjs-three-bg {
      background-color: var(--background) !important;
    }
    
    .gjs-four-color, .gjs-four-color-h:hover {
      color: var(--black) !important;
    }
    
    .gjs-block {
      width: calc(50% - 0.5rem);
      min-height: 70px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      margin: 0.25rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.15s ease;
    }
    
    .gjs-block:hover {
      border-color: var(--black);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .gjs-block svg {
      fill: var(--dark-gray);
    }
    
    .gjs-block-label {
      font-size: 0.7rem;
      color: var(--dark-gray);
      text-align: center;
    }
    
    .gjs-blocks-c {
      display: flex;
      flex-wrap: wrap;
      padding: 0.5rem;
    }
    
    .gjs-category-title {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--mid-gray);
      padding: 0.75rem 1rem 0.5rem;
      background: transparent;
    }
    
    .gjs-sm-sector-title {
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--background);
      padding: 0.75rem 1rem;
      border: none;
    }
    
    .gjs-field {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem;
    }
    
    .gjs-field input {
      background: transparent;
      border: none;
      font-size: 0.875rem;
    }
    
    .gjs-radio-item {
      border-radius: 4px;
    }
    
    .gjs-clm-tags {
      padding: 0.5rem;
    }
    
    .gjs-sm-properties {
      padding: 0.75rem;
    }
    
    .gjs-trt-trait {
      padding: 0.5rem 0;
    }
    
    .gjs-trt-trait__wrp {
      gap: 0.5rem;
    }
    
    .gjs-label {
      font-size: 0.75rem;
      color: var(--dark-gray);
    }
    
    /* Frame wrapper */
    .gjs-frame-wrapper {
      background: var(--white);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
      margin: 1rem;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      padding: 1rem 1.5rem;
      background: var(--black);
      color: var(--white);
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 500;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      animation: slideUp 0.3s ease;
    }
    
    .toast-success {
      background: var(--success);
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 1rem;
      z-index: 200;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--black);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Hide GrapeJS default panels */
    .gjs-pn-panels {
      display: none;
    }
    
    .gjs-cv-canvas {
      top: 0 !important;
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
  <!-- Top Toolbar -->
  <div class="top-toolbar">
    <div class="toolbar-left">
      <a href="/" class="logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M9 9h6M9 13h6M9 17h4"/>
        </svg>
        Screened
      </a>
      <div class="nav-tabs">
        <a href="/" class="nav-tab">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          </svg>
          Home
        </a>
        <a href="/visual-editor.html" class="nav-tab active">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          Editor
        </a>
        <a href="#" class="nav-tab" onclick="showToast('Coming soon!')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M8 12h8M12 8v8"/>
          </svg>
          Create Ads
        </a>
      </div>
    </div>
    
    <div class="toolbar-center">
      <div class="site-selector">
        <label>Site:</label>
        <select id="site-select">
          <option value="">Select a site...</option>
        </select>
      </div>
      
      <div class="device-buttons">
        <button class="device-btn active" data-device="desktop" onclick="setDevice('Desktop')" title="Desktop">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/>
            <line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
        </button>
        <button class="device-btn" data-device="tablet" onclick="setDevice('Tablet')" title="Tablet">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="4" y="2" width="16" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>
          </svg>
        </button>
        <button class="device-btn" data-device="mobile" onclick="setDevice('Mobile portrait')" title="Mobile">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>
          </svg>
        </button>
      </div>
      
      <span style="font-size: 0.75rem; color: var(--mid-gray); margin-left: 0.5rem;" id="canvas-size">1920px</span>
    </div>
    
    <div class="toolbar-right">
      <button class="btn btn-ghost" onclick="editor.runCommand('core:undo')" title="Undo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
        </svg>
      </button>
      <button class="btn btn-ghost" onclick="editor.runCommand('core:redo')" title="Redo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/>
        </svg>
      </button>
      
      <div class="divider"></div>
      
      <button class="btn btn-ghost" onclick="previewPage()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        Preview
      </button>
      
      <button class="btn btn-secondary" onclick="exportPage()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Export
      </button>
      
      <button class="btn btn-success" onclick="publishPage()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13"/><path d="M22 2L15 22l-4-9-9-4 20-7z"/>
        </svg>
        Publish
      </button>
    </div>
  </div>
  
  <!-- Main Editor -->
  <div class="editor-container">
    <!-- Left Panel -->
    <div class="left-panel">
      <div class="panel-tabs">
        <button class="panel-tab active" onclick="showPanel('blocks', this)">Blocks</button>
        <button class="panel-tab" onclick="showPanel('layers', this)">Layers</button>
      </div>
      <div id="blocks" class="blocks-container active"></div>
      <div id="layers" class="layers-container"></div>
    </div>
    
    <!-- Canvas -->
    <div class="canvas-container">
      <div id="gjs"></div>
    </div>
    
    <!-- Right Panel -->
    <div class="right-panel">
      <div class="style-tabs">
        <button class="style-tab active" onclick="showStylePanel('styles', this)">Styles</button>
        <button class="style-tab" onclick="showStylePanel('traits', this)">Settings</button>
      </div>
      <div id="styles-container" class="style-container"></div>
      <div id="traits-container" class="style-container" style="display: none;"></div>
    </div>
  </div>
  
  <!-- Loading -->
  <div class="loading-overlay" id="loading">
    <div class="loading-spinner"></div>
    <div style="font-size: 0.9rem; color: var(--dark-gray);">Loading editor...</div>
  </div>

  <script src="https://unpkg.com/grapesjs"></script>
  <script src="https://unpkg.com/grapesjs-preset-webpage"></script>
  <script src="https://unpkg.com/grapesjs-blocks-basic"></script>
  <script>
    let editor;
    let currentSlug = '';
    
    // Initialize GrapeJS
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      currentSlug = params.get('slug') || 'new-page';
      
      initEditor();
      loadKeywords();
    });
    
    function initEditor() {
      editor = grapesjs.init({
        container: '#gjs',
        height: '100%',
        width: 'auto',
        storageManager: false,
        panels: { defaults: [] },
        
        blockManager: {
          appendTo: '#blocks',
        },
        
        layerManager: {
          appendTo: '#layers',
        },
        
        styleManager: {
          appendTo: '#styles-container',
          sectors: [
            {
              name: 'Dimension',
              open: true,
              properties: [
                'width', 'height', 'max-width', 'min-height', 'margin', 'padding'
              ]
            },
            {
              name: 'Typography',
              open: true,
              properties: [
                'font-family', 'font-size', 'font-weight', 'letter-spacing',
                'color', 'line-height', 'text-align', 'text-decoration'
              ]
            },
            {
              name: 'Background',
              open: false,
              properties: [
                'background-color', 'background-image', 'background-repeat',
                'background-position', 'background-size'
              ]
            },
            {
              name: 'Border',
              open: false,
              properties: [
                'border-radius', 'border-width', 'border-style', 'border-color',
                'box-shadow'
              ]
            },
            {
              name: 'Flexbox',
              open: false,
              properties: [
                'display', 'flex-direction', 'justify-content', 'align-items',
                'flex-wrap', 'gap'
              ]
            }
          ]
        },
        
        traitManager: {
          appendTo: '#traits-container',
        },
        
        deviceManager: {
          devices: [
            { name: 'Desktop', width: '' },
            { name: 'Tablet', width: '768px', widthMedia: '768px' },
            { name: 'Mobile portrait', width: '375px', widthMedia: '375px' }
          ]
        },
        
        canvas: {
          styles: [
            'https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Lexend:wght@400;500;600;700&display=swap'
          ]
        },
        
        plugins: ['gjs-blocks-basic'],
        pluginsOpts: {
          'gjs-blocks-basic': {
            flexGrid: true,
          }
        }
      });
      
      // Add custom Screened blocks
      addCustomBlocks();
      
      // Load saved content if exists
      loadContent();
      
      // Hide loading
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
      }, 500);
      
      // Update canvas size indicator
      editor.on('device:select', (device) => {
        document.getElementById('canvas-size').textContent = device.get('width') || '1920px';
        updateDeviceButtons(device.get('name'));
      });
    }
    
    function addCustomBlocks() {
      const bm = editor.BlockManager;
      
      // Clear default blocks we don't need
      bm.getAll().reset();
      
      // === LAYOUT BLOCKS ===
      bm.add('section', {
        label: 'Section',
        category: 'Layout',
        content: `<section style="padding: 4rem 1.5rem; max-width: 1200px; margin: 0 auto;">
          <div data-gjs-type="text">Section content here...</div>
        </section>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
        </svg>`
      });
      
      bm.add('container', {
        label: 'Container',
        category: 'Layout',
        content: `<div style="max-width: 1200px; margin: 0 auto; padding: 0 1.5rem;">
        </div>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="2" y="4" width="20" height="16" rx="2"/>
        </svg>`
      });
      
      bm.add('columns-2', {
        label: '2 Columns',
        category: 'Layout',
        content: `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
          <div style="padding: 1.5rem; background: #f8fafc; border-radius: 12px;">Column 1</div>
          <div style="padding: 1.5rem; background: #f8fafc; border-radius: 12px;">Column 2</div>
        </div>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="8" height="18" rx="1"/><rect x="13" y="3" width="8" height="18" rx="1"/>
        </svg>`
      });
      
      bm.add('columns-3', {
        label: '3 Columns',
        category: 'Layout',
        content: `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
          <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">Column 1</div>
          <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">Column 2</div>
          <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">Column 3</div>
        </div>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="2" y="3" width="5" height="18" rx="1"/><rect x="9.5" y="3" width="5" height="18" rx="1"/>
          <rect x="17" y="3" width="5" height="18" rx="1"/>
        </svg>`
      });
      
      // === SCREENED COMPONENTS ===
      bm.add('hero', {
        label: 'Hero Section',
        category: 'Screened',
        content: `<section style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 5rem 1.5rem; text-align: center;">
          <div style="max-width: 800px; margin: 0 auto;">
            <span style="display: inline-block; padding: 0.375rem 0.75rem; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1.5rem;">INSURANCE</span>
            <h1 style="font-family: 'Sora', sans-serif; font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; letter-spacing: -0.02em;">Best Travel Insurance Companies 2025</h1>
            <p style="font-size: 1.125rem; color: rgba(255,255,255,0.8); margin-bottom: 1.5rem;">Compare top-rated travel insurance providers with comprehensive coverage, competitive pricing, and excellent customer service.</p>
            <div style="font-size: 0.875rem; color: rgba(255,255,255,0.6);">By Sarah Chen | Updated Dec 12, 2025</div>
          </div>
        </section>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="2" y="2" width="20" height="8" rx="2"/><line x1="6" y1="5" x2="18" y2="5"/>
          <line x1="8" y1="7" x2="16" y2="7"/>
        </svg>`
      });
      
      bm.add('provider-card', {
        label: 'Provider Card',
        category: 'Screened',
        content: `<div style="background: white; border: 1px solid #e2e8f0; border-radius: 16px; overflow: hidden; margin-bottom: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
            <div>
              <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <img src="/insurance-logos-small/allianz.png" alt="Logo" style="width: 48px; height: 48px; object-fit: contain;">
                <div>
                  <h3 style="font-family: 'Lexend', sans-serif; font-size: 1.25rem; font-weight: 600; color: #0f172a;">1. Allianz Travel Insurance</h3>
                  <span style="font-size: 0.8rem; color: #64748b;">Best for Overall Coverage</span>
                </div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem; font-family: 'Lexend', sans-serif; font-weight: 600; font-size: 1.125rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="#0f172a"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              4.8
            </div>
          </div>
          <div style="padding: 1.5rem;">
            <p style="color: #475569; margin-bottom: 1.25rem; line-height: 1.7;">Allianz offers comprehensive travel insurance plans with excellent medical coverage, trip cancellation benefits, and 24/7 assistance services worldwide.</p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.25rem;">
              <div style="text-align: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem;">Monthly Avg</div>
                <div style="font-family: 'Lexend', sans-serif; font-weight: 600; font-size: 0.9rem;">$45-$89</div>
              </div>
              <div style="text-align: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem;">Coverage</div>
                <div style="font-family: 'Lexend', sans-serif; font-weight: 600; font-size: 0.9rem;">$500K</div>
              </div>
              <div style="text-align: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem;">Deductible</div>
                <div style="font-family: 'Lexend', sans-serif; font-weight: 600; font-size: 0.9rem;">$0-$250</div>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
              <div>
                <h4 style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.75rem; color: #475569;">Pros</h4>
                <ul style="list-style: none; font-size: 0.875rem; color: #475569; padding: 0;">
                  <li style="padding: 0.375rem 0; padding-left: 1.25rem; position: relative;">✓ Comprehensive medical coverage</li>
                  <li style="padding: 0.375rem 0; padding-left: 1.25rem; position: relative;">✓ 24/7 emergency assistance</li>
                  <li style="padding: 0.375rem 0; padding-left: 1.25rem; position: relative;">✓ Cancel for any reason option</li>
                </ul>
              </div>
              <div>
                <h4 style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.75rem; color: #475569;">Cons</h4>
                <ul style="list-style: none; font-size: 0.875rem; color: #475569; padding: 0;">
                  <li style="padding: 0.375rem 0; padding-left: 1.25rem; position: relative;">✗ Higher premiums</li>
                  <li style="padding: 0.375rem 0; padding-left: 1.25rem; position: relative;">✗ Complex policy terms</li>
                </ul>
              </div>
            </div>
          </div>
          <div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; background: #f8fafc;">
            <a href="#" style="display: block; text-align: center; padding: 0.875rem; background: #0f172a; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem;">View Plans →</a>
          </div>
        </div>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2"/><line x1="7" y1="8" x2="17" y2="8"/>
          <line x1="7" y1="12" x2="14" y2="12"/><line x1="7" y1="16" x2="10" y2="16"/>
        </svg>`
      });
      
      bm.add('faq-section', {
        label: 'FAQ Section',
        category: 'Screened',
        content: `<section style="max-width: 800px; margin: 0 auto; padding: 4rem 1.5rem;">
          <h2 style="font-family: 'Sora', sans-serif; font-size: 1.75rem; font-weight: 700; text-align: center; margin-bottom: 2rem;">Frequently Asked Questions</h2>
          <div style="border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
            <details style="border-bottom: 1px solid #e2e8f0;">
              <summary style="padding: 1rem 1.25rem; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">What does travel insurance cover?</summary>
              <div style="padding: 0 1.25rem 1rem; color: #475569; line-height: 1.7;">Travel insurance typically covers trip cancellation, medical emergencies, lost luggage, and travel delays. Coverage varies by policy and provider.</div>
            </details>
            <details style="border-bottom: 1px solid #e2e8f0;">
              <summary style="padding: 1rem 1.25rem; font-weight: 600; cursor: pointer;">How much does travel insurance cost?</summary>
              <div style="padding: 0 1.25rem 1rem; color: #475569; line-height: 1.7;">Travel insurance typically costs 4-10% of your total trip cost, depending on the coverage level and your age.</div>
            </details>
            <details>
              <summary style="padding: 1rem 1.25rem; font-weight: 600; cursor: pointer;">When should I buy travel insurance?</summary>
              <div style="padding: 0 1.25rem 1rem; color: #475569; line-height: 1.7;">It's best to purchase travel insurance within 14-21 days of making your initial trip deposit to get the most comprehensive coverage options.</div>
            </details>
          </div>
        </section>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>`
      });
      
      bm.add('cta-button', {
        label: 'CTA Button',
        category: 'Screened',
        content: `<a href="#" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 2rem; background: #0f172a; color: white; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 0.9375rem; transition: all 0.2s;">
          Get Your Quote →
        </a>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="8" width="18" height="8" rx="4"/>
        </svg>`
      });
      
      bm.add('stats-grid', {
        label: 'Stats Grid',
        category: 'Screened',
        content: `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; padding: 2rem; background: #f8fafc; border-radius: 16px;">
          <div style="text-align: center;">
            <div style="font-family: 'Lexend', sans-serif; font-size: 2rem; font-weight: 700; color: #0f172a;">50+</div>
            <div style="font-size: 0.8rem; color: #64748b;">Providers Reviewed</div>
          </div>
          <div style="text-align: center;">
            <div style="font-family: 'Lexend', sans-serif; font-size: 2rem; font-weight: 700; color: #0f172a;">100K+</div>
            <div style="font-size: 0.8rem; color: #64748b;">Quotes Compared</div>
          </div>
          <div style="text-align: center;">
            <div style="font-family: 'Lexend', sans-serif; font-size: 2rem; font-weight: 700; color: #0f172a;">4.8</div>
            <div style="font-size: 0.8rem; color: #64748b;">Average Rating</div>
          </div>
          <div style="text-align: center;">
            <div style="font-family: 'Lexend', sans-serif; font-size: 2rem; font-weight: 700; color: #0f172a;">24/7</div>
            <div style="font-size: 0.8rem; color: #64748b;">Support Available</div>
          </div>
        </div>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
        </svg>`
      });
      
      bm.add('comparison-table', {
        label: 'Comparison Table',
        category: 'Screened',
        content: `<div style="overflow-x: auto; margin: 2rem 0;">
          <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <thead>
              <tr style="background: #0f172a; color: white;">
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Provider</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem;">Monthly Cost</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem;">Coverage</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem;">Rating</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.875rem;"></th>
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 1rem; font-weight: 600;">Allianz</td>
                <td style="padding: 1rem; text-align: center;">$45-$89</td>
                <td style="padding: 1rem; text-align: center;">$500K</td>
                <td style="padding: 1rem; text-align: center;">4.8 ⭐</td>
                <td style="padding: 1rem; text-align: center;"><a href="#" style="color: #0f172a; font-weight: 600; text-decoration: none;">View →</a></td>
              </tr>
              <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 1rem; font-weight: 600;">World Nomads</td>
                <td style="padding: 1rem; text-align: center;">$35-$75</td>
                <td style="padding: 1rem; text-align: center;">$100K</td>
                <td style="padding: 1rem; text-align: center;">4.6 ⭐</td>
                <td style="padding: 1rem; text-align: center;"><a href="#" style="color: #0f172a; font-weight: 600; text-decoration: none;">View →</a></td>
              </tr>
              <tr>
                <td style="padding: 1rem; font-weight: 600;">SafetyWing</td>
                <td style="padding: 1rem; text-align: center;">$42/mo</td>
                <td style="padding: 1rem; text-align: center;">$250K</td>
                <td style="padding: 1rem; text-align: center;">4.5 ⭐</td>
                <td style="padding: 1rem; text-align: center;"><a href="#" style="color: #0f172a; font-weight: 600; text-decoration: none;">View →</a></td>
              </tr>
            </tbody>
          </table>
        </div>`,
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/>
          <line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/>
        </svg>`
      });
      
      // === BASIC ELEMENTS ===
      bm.add('text', {
        label: 'Text',
        category: 'Basic',
        content: '<p style="font-size: 1rem; color: #475569; line-height: 1.7;">Add your text content here...</p>',
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/>
          <line x1="12" y1="4" x2="12" y2="20"/>
        </svg>`
      });
      
      bm.add('heading', {
        label: 'Heading',
        category: 'Basic',
        content: '<h2 style="font-family: \'Sora\', sans-serif; font-size: 1.75rem; font-weight: 700; color: #0f172a; margin-bottom: 1rem;">Your Heading Here</h2>',
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M6 4v16M18 4v16M6 12h12"/>
        </svg>`
      });
      
      bm.add('image', {
        label: 'Image',
        category: 'Basic',
        content: '<img src="https://placehold.co/800x400/f8fafc/64748b?text=Click+to+change+image" style="max-width: 100%; height: auto; border-radius: 12px;">',
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>`
      });
      
      bm.add('link', {
        label: 'Link',
        category: 'Basic',
        content: '<a href="#" style="color: #0f172a; font-weight: 600; text-decoration: underline;">Link text</a>',
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
        </svg>`
      });
      
      bm.add('divider', {
        label: 'Divider',
        category: 'Basic',
        content: '<hr style="border: none; border-top: 1px solid #e2e8f0; margin: 2rem 0;">',
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <line x1="3" y1="12" x2="21" y2="12"/>
        </svg>`
      });
      
      bm.add('spacer', {
        label: 'Spacer',
        category: 'Basic',
        content: '<div style="height: 3rem;"></div>',
        media: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/>
        </svg>`
      });
    }
    
    // Load keywords for site selector
    async function loadKeywords() {
      try {
        const res = await fetch('/api/keywords');
        const data = await res.json();
        const select = document.getElementById('site-select');
        
        data.keywords.forEach(k => {
          const option = document.createElement('option');
          option.value = k.slug;
          option.textContent = k.keyword;
          if (k.slug === currentSlug) {
            option.selected = true;
          }
          select.appendChild(option);
        });
        
        select.addEventListener('change', (e) => {
          if (e.target.value) {
            window.location.href = `/visual-editor.html?slug=${e.target.value}`;
          }
        });
      } catch (error) {
        console.log('Could not load keywords');
      }
    }
    
    // Load saved content
    async function loadContent() {
      if (!currentSlug || currentSlug === 'new-page') {
        // Load default template
        editor.setComponents(`
          <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 0; background: #f8fafc;">
          </body>
        `);
        return;
      }
      
      try {
        const res = await fetch(`/api/visual-content/${currentSlug}`);
        if (res.ok) {
          const data = await res.json();
          if (data.html) {
            editor.setComponents(data.html);
            if (data.css) {
              editor.setStyle(data.css);
            }
          }
        }
      } catch (error) {
        console.log('No saved content, starting fresh');
      }
    }
    
    // Device switching
    function setDevice(device) {
      editor.setDevice(device);
    }
    
    function updateDeviceButtons(deviceName) {
      document.querySelectorAll('.device-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.device === deviceName.toLowerCase().replace(' ', '-') || 
            (deviceName === 'Desktop' && btn.dataset.device === 'desktop') ||
            (deviceName === 'Tablet' && btn.dataset.device === 'tablet') ||
            (deviceName === 'Mobile portrait' && btn.dataset.device === 'mobile')) {
          btn.classList.add('active');
        }
      });
    }
    
    // Panel switching
    function showPanel(panel, btn) {
      document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      
      document.getElementById('blocks').classList.toggle('active', panel === 'blocks');
      document.getElementById('layers').classList.toggle('active', panel === 'layers');
      document.querySelector('.layers-container').style.display = panel === 'layers' ? 'block' : 'none';
      document.querySelector('.blocks-container').style.display = panel === 'blocks' ? 'block' : 'none';
    }
    
    function showStylePanel(panel, btn) {
      document.querySelectorAll('.style-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      
      document.getElementById('styles-container').style.display = panel === 'styles' ? 'block' : 'none';
      document.getElementById('traits-container').style.display = panel === 'traits' ? 'block' : 'none';
    }
    
    // Preview
    function previewPage() {
      const html = editor.getHtml();
      const css = editor.getCss();
      
      const previewWindow = window.open('', '_blank');
      previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Preview</title>
          <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
          <style>${css}</style>
        </head>
        <body>${html}</body>
        </html>
      `);
      previewWindow.document.close();
    }
    
    // Export
    function exportPage() {
      const html = editor.getHtml();
      const css = editor.getCss();
      
      const fullHtml = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exported Page</title>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
${css}
  </style>
</head>
<body>
${html}
</body>
</html>`;
      
      const blob = new Blob([fullHtml], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentSlug || 'page'}.html`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Page exported!');
    }
    
    // Save
    async function saveContent() {
      const html = editor.getHtml();
      const css = editor.getCss();
      
      try {
        await fetch(`/api/visual-content/${currentSlug}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ html, css })
        });
        return true;
      } catch (error) {
        console.error('Failed to save:', error);
        return false;
      }
    }
    
    // Publish
    async function publishPage() {
      showToast('Publishing...', 'info');
      
      // Save content first
      await saveContent();
      
      try {
        const res = await fetch(`/api/visual-publish/${currentSlug}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            html: editor.getHtml(),
            css: editor.getCss()
          })
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast('Published! Deploying to live site...', 'success');
        } else {
          showToast('Failed to publish: ' + result.error, 'error');
        }
      } catch (error) {
        showToast('Failed to publish', 'error');
      }
    }
    
    // Toast
    function showToast(message, type = 'info') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'toast-success' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    // Auto-save
    setInterval(() => {
      if (currentSlug && currentSlug !== 'new-page') {
        saveContent();
      }
    }, 30000);
  </script>
</body>
</html>

