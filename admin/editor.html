<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Article Editor - Screened Admin</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M9 9h6M9 13h6M9 17h4"/>
        </svg>
        <span>Screened</span>
      </div>
      <nav class="nav">
        <a href="/" class="nav-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
          </svg>
          Dashboard
        </a>
        <a href="/editor" class="nav-item active">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          Editor
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Header -->
      <header class="header">
        <div>
          <h1 id="page-title">New Article</h1>
          <p class="header-subtitle" id="page-subtitle">Create a new comparison article</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="previewArticle()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            Preview
          </button>
          <button class="btn btn-secondary" onclick="saveDraft()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
            </svg>
            Save Draft
          </button>
          <button class="btn btn-primary" onclick="publishArticle()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Publish
          </button>
        </div>
      </header>

      <!-- Editor Layout -->
      <div class="editor-layout">
        <!-- Main Editor -->
        <div class="editor-main">
          <!-- Basic Info -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">Basic Information</span>
            </div>
            <div class="form-group">
              <label class="form-label">Article Title</label>
              <input type="text" id="title" class="form-input" placeholder="Best Travel Credit Cards 2025: Top 10 Ranked">
              <p class="form-help">Include the year and number of items for SEO</p>
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea id="description" class="form-textarea" placeholder="A compelling meta description for search results..." rows="3"></textarea>
              <p class="form-help">150-160 characters for optimal SEO</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label class="form-label">Category</label>
                <select id="category" class="form-select">
                  <option value="credit-cards">Credit Cards</option>
                  <option value="insurance">Insurance</option>
                  <option value="finance">Finance</option>
                  <option value="tech">Tech</option>
                  <option value="home">Home</option>
                  <option value="lifestyle">Lifestyle</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Author</label>
                <select id="author" class="form-select">
                  <option value="Sarah Chen">Sarah Chen</option>
                  <option value="Marcus Williams">Marcus Williams</option>
                  <option value="Jennifer Torres">Jennifer Torres</option>
                  <option value="Screened Editorial Team">Screened Editorial Team</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Research Introduction</label>
              <textarea id="researchIntro" class="form-textarea" placeholder="After analyzing X providers across Y key metrics..." rows="2"></textarea>
              <p class="form-help">Establishes credibility at the top of the article</p>
            </div>
          </div>

          <!-- Providers Section -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">Providers / Products</span>
              <button class="btn btn-secondary" onclick="addProvider()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Provider
              </button>
            </div>
            <div id="providers-list">
              <!-- Provider cards will be added here -->
            </div>
          </div>

          <!-- SEO Content -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">SEO Content (Markdown)</span>
            </div>
            <div class="form-group">
              <textarea id="content" class="form-textarea" style="min-height: 400px; font-family: var(--font-mono); font-size: 0.85rem;" placeholder="## How We Ranked These Providers

Write your SEO content here using Markdown...

### Key Takeaways

- **Top Pick:** Provider name for best overall
- **Budget Choice:** Provider for value seekers

### How to Choose

Content about selection criteria..."></textarea>
              <p class="form-help">Use Markdown formatting. H2 and H3 headings create the article structure.</p>
            </div>
          </div>

          <!-- FAQs -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">Frequently Asked Questions</span>
              <button class="btn btn-secondary" onclick="addFaq()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add FAQ
              </button>
            </div>
            <div id="faqs-list">
              <!-- FAQ items will be added here -->
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="editor-sidebar">
          <!-- Status Card -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">Status</span>
            </div>
            <div class="form-group">
              <label class="form-label">Current Status</label>
              <select id="status" class="form-select">
                <option value="draft">Draft</option>
                <option value="in_progress">In Progress</option>
                <option value="published">Published</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Slug</label>
              <input type="text" id="slug" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">Last Modified</label>
              <input type="text" id="lastModified" class="form-input" readonly value="Never">
            </div>
          </div>

          <!-- Hero Image -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">Hero Image</span>
            </div>
            <div class="form-group">
              <label class="form-label">Image Path</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="heroImage" class="form-input" placeholder="/insurance-heroes/travel.jpeg">
                <button class="btn btn-secondary" onclick="browseImages('heroImage', 'insurance-heroes')">Browse</button>
              </div>
            </div>
            <div id="hero-preview" style="margin-top: 0.75rem; border-radius: 8px; overflow: hidden; background: var(--background);">
              <img id="hero-img" src="" style="width: 100%; display: none;" onerror="this.style.display='none'" onload="this.style.display='block'">
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">Quick Actions</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <button class="btn btn-secondary" style="width: 100%;" onclick="openInCursor()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                  <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
                Edit in Cursor (AI)
              </button>
              <button class="btn btn-secondary" style="width: 100%;" onclick="loadTemplate()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                </svg>
                Load Template
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Image Picker Modal -->
  <div id="image-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Select Image</span>
        <button class="btn-icon" onclick="closeImageModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Folder</label>
          <select id="image-folder" class="form-select" onchange="loadImages()">
            <option value="insurance-logos-small">Insurance Logos</option>
            <option value="credit-cards">Credit Cards</option>
            <option value="insurance-heroes">Insurance Heroes</option>
            <option value="blog-images">Blog Images</option>
          </select>
        </div>
        <div id="image-grid" class="image-grid">
          <!-- Images will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeImageModal()">Cancel</button>
        <button class="btn btn-primary" onclick="selectImage()">Select</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentSlug = '';
    let article = {
      title: '',
      description: '',
      category: 'credit-cards',
      author: 'Sarah Chen',
      heroImage: '',
      researchIntro: '',
      providers: [],
      faqs: [],
      content: '',
      status: 'draft'
    };
    let imageModalTarget = null;
    let selectedImage = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      currentSlug = params.get('slug');
      
      if (currentSlug) {
        loadArticle(currentSlug);
        loadKeywordInfo(currentSlug);
      } else {
        // Add one empty provider by default
        addProvider();
        addFaq();
      }
    });

    // Load keyword info
    async function loadKeywordInfo(slug) {
      try {
        const res = await fetch(`/api/keywords/${slug}`);
        if (res.ok) {
          const keyword = await res.json();
          document.getElementById('page-title').textContent = keyword.keyword;
          document.getElementById('page-subtitle').textContent = `${keyword.category} | P${keyword.priority} | ${formatNumber(keyword.search_volume)} searches/mo`;
          document.getElementById('slug').value = slug;
          
          // Pre-fill title if empty
          if (!article.title) {
            document.getElementById('title').value = `Best ${titleCase(keyword.keyword.replace('best ', ''))} 2025: Top 10 Ranked`;
            document.getElementById('category').value = keyword.category;
          }
        }
      } catch (error) {
        console.error('Failed to load keyword info:', error);
      }
    }

    // Load existing article
    async function loadArticle(slug) {
      try {
        const res = await fetch(`/api/articles/${slug}`);
        if (res.ok) {
          article = await res.json();
          populateForm();
        }
      } catch (error) {
        console.log('No existing article found, starting fresh');
        addProvider();
        addFaq();
      }
    }

    // Populate form with article data
    function populateForm() {
      document.getElementById('title').value = article.title || '';
      document.getElementById('description').value = article.description || '';
      document.getElementById('category').value = article.category || 'credit-cards';
      document.getElementById('author').value = article.author || 'Sarah Chen';
      document.getElementById('heroImage').value = article.heroImage || '';
      document.getElementById('researchIntro').value = article.researchIntro || '';
      document.getElementById('content').value = article.content || '';
      document.getElementById('status').value = article.status || 'draft';
      document.getElementById('lastModified').value = article.lastModified ? new Date(article.lastModified).toLocaleString() : 'Never';
      
      // Update hero preview
      if (article.heroImage) {
        document.getElementById('hero-img').src = article.heroImage;
      }
      
      // Render providers
      document.getElementById('providers-list').innerHTML = '';
      if (article.providers && article.providers.length > 0) {
        article.providers.forEach((p, i) => addProvider(p));
      } else {
        addProvider();
      }
      
      // Render FAQs
      document.getElementById('faqs-list').innerHTML = '';
      if (article.faqs && article.faqs.length > 0) {
        article.faqs.forEach((f, i) => addFaq(f));
      } else {
        addFaq();
      }
    }

    // Collect form data
    function collectFormData() {
      const providers = [];
      document.querySelectorAll('.provider-card').forEach(card => {
        providers.push({
          name: card.querySelector('[data-field="name"]').value,
          logo: card.querySelector('[data-field="logo"]').value,
          bestFor: card.querySelector('[data-field="bestFor"]').value,
          monthlyAvg: card.querySelector('[data-field="monthlyAvg"]').value,
          serviceFee: card.querySelector('[data-field="serviceFee"]')?.value || '',
          rating: parseFloat(card.querySelector('[data-field="rating"]').value) || 4.5,
          description: card.querySelector('[data-field="description"]').value,
          affiliateUrl: card.querySelector('[data-field="affiliateUrl"]').value,
          pros: Array.from(card.querySelectorAll('[data-field="pros"] input')).map(i => i.value).filter(v => v),
          cons: Array.from(card.querySelectorAll('[data-field="cons"] input')).map(i => i.value).filter(v => v)
        });
      });

      const faqs = [];
      document.querySelectorAll('.faq-item').forEach(item => {
        const q = item.querySelector('[data-field="question"]').value;
        const a = item.querySelector('[data-field="answer"]').value;
        if (q && a) faqs.push({ question: q, answer: a });
      });

      return {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        category: document.getElementById('category').value,
        author: document.getElementById('author').value,
        heroImage: document.getElementById('heroImage').value,
        researchIntro: document.getElementById('researchIntro').value,
        content: document.getElementById('content').value,
        status: document.getElementById('status').value,
        providers,
        faqs
      };
    }

    // Save draft
    async function saveDraft() {
      const data = collectFormData();
      const slug = currentSlug || generateSlug(data.title);
      
      try {
        const res = await fetch(`/api/articles/${slug}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...data, status: 'draft' })
        });
        
        if (res.ok) {
          showToast('Draft saved successfully', 'success');
          if (!currentSlug) {
            currentSlug = slug;
            document.getElementById('slug').value = slug;
            history.pushState({}, '', `/editor?slug=${slug}`);
          }
          document.getElementById('lastModified').value = new Date().toLocaleString();
        } else {
          throw new Error('Failed to save');
        }
      } catch (error) {
        showToast('Failed to save draft', 'error');
        console.error(error);
      }
    }

    // Publish article
    async function publishArticle() {
      const data = collectFormData();
      const slug = currentSlug || generateSlug(data.title);
      
      // Validate
      if (!data.title) {
        showToast('Please enter a title', 'error');
        return;
      }
      if (data.providers.length === 0 || !data.providers[0].name) {
        showToast('Please add at least one provider', 'error');
        return;
      }
      
      try {
        // First save
        await fetch(`/api/articles/${slug}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...data, status: 'published' })
        });
        
        // Then publish
        const res = await fetch(`/api/publish/${slug}`, { method: 'POST' });
        const result = await res.json();
        
        if (result.success) {
          showToast('Article published! Deploying to Vercel...', 'success');
          document.getElementById('status').value = 'published';
          setTimeout(() => {
            if (confirm('Article published! Would you like to view it?')) {
              window.open(result.url, '_blank');
            }
          }, 1000);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showToast('Failed to publish: ' + error.message, 'error');
        console.error(error);
      }
    }

    // Preview article
    function previewArticle() {
      saveDraft().then(() => {
        window.open(`/preview?slug=${currentSlug}`, '_blank');
      });
    }

    // Add provider
    function addProvider(data = {}) {
      const container = document.getElementById('providers-list');
      const index = container.children.length + 1;
      
      const card = document.createElement('div');
      card.className = 'provider-card';
      card.innerHTML = `
        <div class="provider-header">
          <span class="provider-number">Provider #${index}</span>
          <div class="provider-actions">
            <button class="btn-icon" onclick="moveProvider(this, -1)" title="Move Up">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="18 15 12 9 6 15"/>
              </svg>
            </button>
            <button class="btn-icon" onclick="moveProvider(this, 1)" title="Move Down">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </button>
            <button class="btn-icon" onclick="removeProvider(this)" title="Remove">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="provider-grid">
          <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" data-field="name" class="form-input" placeholder="Company Name" value="${data.name || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Best For</label>
            <input type="text" data-field="bestFor" class="form-input" placeholder="Overall Coverage" value="${data.bestFor || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Logo</label>
            <div class="logo-picker">
              <div class="logo-preview">
                <img src="${data.logo || ''}" onerror="this.style.display='none'" onload="this.style.display='block'">
              </div>
              <input type="text" data-field="logo" class="form-input" placeholder="/insurance-logos-small/company.png" value="${data.logo || ''}" onchange="updateLogoPreview(this)">
              <button class="btn btn-secondary btn-icon" onclick="browseImages(this.parentElement.querySelector('[data-field=logo]'), 'insurance-logos-small')">...</button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Rating (out of 5)</label>
            <input type="number" data-field="rating" class="form-input" placeholder="4.5" min="1" max="5" step="0.1" value="${data.rating || 4.5}">
          </div>
          <div class="form-group">
            <label class="form-label">Monthly Avg</label>
            <input type="text" data-field="monthlyAvg" class="form-input" placeholder="$49-$59" value="${data.monthlyAvg || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Service Fee</label>
            <input type="text" data-field="serviceFee" class="form-input" placeholder="$125" value="${data.serviceFee || ''}">
          </div>
          <div class="form-group provider-full">
            <label class="form-label">Description</label>
            <textarea data-field="description" class="form-textarea" rows="2" placeholder="Brief description of this provider...">${data.description || ''}</textarea>
          </div>
          <div class="form-group provider-full">
            <label class="form-label">Affiliate URL</label>
            <input type="text" data-field="affiliateUrl" class="form-input" placeholder="https://..." value="${data.affiliateUrl || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Pros</label>
            <div class="list-editor" data-field="pros">
              ${(data.pros || ['', '', '']).map(p => `
                <div class="list-item">
                  <input type="text" class="form-input" placeholder="Pro point..." value="${p}">
                  <button class="btn-icon" onclick="removeListItem(this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                </div>
              `).join('')}
            </div>
            <button class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.75rem; padding: 0.375rem 0.625rem;" onclick="addListItem(this.previousElementSibling)">+ Add Pro</button>
          </div>
          <div class="form-group">
            <label class="form-label">Cons</label>
            <div class="list-editor" data-field="cons">
              ${(data.cons || ['', '']).map(c => `
                <div class="list-item">
                  <input type="text" class="form-input" placeholder="Con point..." value="${c}">
                  <button class="btn-icon" onclick="removeListItem(this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                </div>
              `).join('')}
            </div>
            <button class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.75rem; padding: 0.375rem 0.625rem;" onclick="addListItem(this.previousElementSibling)">+ Add Con</button>
          </div>
        </div>
      `;
      
      container.appendChild(card);
    }

    // Remove provider
    function removeProvider(btn) {
      const card = btn.closest('.provider-card');
      if (document.querySelectorAll('.provider-card').length > 1) {
        card.remove();
        renumberProviders();
      } else {
        showToast('Need at least one provider', 'error');
      }
    }

    // Move provider
    function moveProvider(btn, direction) {
      const card = btn.closest('.provider-card');
      const container = card.parentElement;
      const cards = Array.from(container.children);
      const index = cards.indexOf(card);
      
      if (direction === -1 && index > 0) {
        container.insertBefore(card, cards[index - 1]);
      } else if (direction === 1 && index < cards.length - 1) {
        container.insertBefore(cards[index + 1], card);
      }
      renumberProviders();
    }

    // Renumber providers
    function renumberProviders() {
      document.querySelectorAll('.provider-card').forEach((card, i) => {
        card.querySelector('.provider-number').textContent = `Provider #${i + 1}`;
      });
    }

    // Add FAQ
    function addFaq(data = {}) {
      const container = document.getElementById('faqs-list');
      const item = document.createElement('div');
      item.className = 'faq-item';
      item.innerHTML = `
        <div class="faq-header">
          <span style="font-size: 0.8rem; font-weight: 600; color: var(--mid-gray);">FAQ</span>
          <button class="btn-icon" onclick="this.closest('.faq-item').remove()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="form-group">
          <label class="form-label">Question</label>
          <input type="text" data-field="question" class="form-input" placeholder="What is the best...?" value="${data.question || ''}">
        </div>
        <div class="form-group">
          <label class="form-label">Answer</label>
          <textarea data-field="answer" class="form-textarea" rows="3" placeholder="The answer to this question...">${data.answer || ''}</textarea>
        </div>
      `;
      container.appendChild(item);
    }

    // List item helpers
    function addListItem(container) {
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <input type="text" class="form-input" placeholder="Point...">
        <button class="btn-icon" onclick="removeListItem(this)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      `;
      container.appendChild(item);
    }

    function removeListItem(btn) {
      btn.closest('.list-item').remove();
    }

    // Update logo preview
    function updateLogoPreview(input) {
      const preview = input.closest('.logo-picker').querySelector('.logo-preview img');
      preview.src = input.value;
    }

    // Image picker
    function browseImages(targetInput, defaultFolder) {
      imageModalTarget = typeof targetInput === 'string' ? document.getElementById(targetInput) : targetInput;
      document.getElementById('image-folder').value = defaultFolder || 'insurance-logos-small';
      document.getElementById('image-modal').style.display = 'flex';
      loadImages();
    }

    function closeImageModal() {
      document.getElementById('image-modal').style.display = 'none';
      selectedImage = null;
    }

    async function loadImages() {
      const folder = document.getElementById('image-folder').value;
      const grid = document.getElementById('image-grid');
      
      try {
        const res = await fetch(`/api/images/${folder}`);
        const data = await res.json();
        
        grid.innerHTML = data.images.map(img => `
          <div class="image-option" onclick="selectImageOption(this, '${img.path}')">
            <img src="${img.path}" alt="${img.name}">
          </div>
        `).join('');
      } catch (error) {
        grid.innerHTML = '<p style="grid-column: span 4; text-align: center; color: var(--mid-gray);">Failed to load images</p>';
      }
    }

    function selectImageOption(element, path) {
      document.querySelectorAll('.image-option').forEach(e => e.classList.remove('selected'));
      element.classList.add('selected');
      selectedImage = path;
    }

    function selectImage() {
      if (selectedImage && imageModalTarget) {
        imageModalTarget.value = selectedImage;
        // Trigger change event for logo preview
        imageModalTarget.dispatchEvent(new Event('change'));
        // Update hero preview if applicable
        if (imageModalTarget.id === 'heroImage') {
          document.getElementById('hero-img').src = selectedImage;
        }
      }
      closeImageModal();
    }

    // Hero image preview
    document.getElementById('heroImage').addEventListener('change', function() {
      document.getElementById('hero-img').src = this.value;
    });

    // Open in Cursor
    function openInCursor() {
      const slug = currentSlug || generateSlug(document.getElementById('title').value);
      showToast('Save the article first, then open the JSON file in Cursor', 'info');
    }

    // Load template
    function loadTemplate() {
      const category = document.getElementById('category').value;
      // Load a template based on category
      document.getElementById('content').value = `## How We Ranked These ${titleCase(category.replace('-', ' '))}

After extensive research and testing, we evaluated each provider based on coverage, pricing, customer service, and overall value.

<div class="key-takeaways">
<h3>Key Takeaways</h3>
<ul>
<li><strong>Top Pick:</strong> [Provider Name] for best overall value</li>
<li><strong>Budget Choice:</strong> [Provider Name] for cost-conscious consumers</li>
<li><strong>Premium Option:</strong> [Provider Name] for comprehensive coverage</li>
</ul>
</div>

## What to Look For

When choosing a provider, consider these key factors:

- **Coverage**: What's included and excluded
- **Pricing**: Monthly costs and deductibles
- **Customer Service**: Response times and satisfaction ratings
- **Claims Process**: How easy it is to file and resolve claims

## How to Choose the Right Provider

The best provider depends on your specific needs and budget. Consider your priorities and compare multiple quotes before making a decision.

<div class="info-box">
<h4>Pro Tip</h4>
<p>Always read the fine print and understand exclusions before signing up.</p>
</div>
`;
      showToast('Template loaded', 'success');
    }

    // Utilities
    function generateSlug(title) {
      return title.toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
    }

    function titleCase(str) {
      return str.replace(/\b\w/g, l => l.toUpperCase());
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num;
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>

